---
title: "Advanced Model Specifications"
author: "Achaz von Hardenberg"  
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Advanced Model Specifications}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>", eval = FALSE
)
```

# Advanced Model Specifications

This vignette covers advanced features in because for specifying complex statistical models.

## Random Effects (Mixed Models)

Random effects account for hierarchical structure in your data, such as repeated measures, grouped observations, or nested designs.

### Basic Random Intercepts

```{r, eval=FALSE}
# Individuals nested within sites
fit <- because(
    equations = list(
        weight ~ age + temperature
    ),
    data = data,
    random = ~ (1 | site), # Random intercept for each site
    n.chains = 2,
    n.iter = 2000
)
```

### Multiple Random Effects

```{r, eval=FALSE}
# Crossed random effects
fit <- because(
    equations = list(
        response ~ treatment
    ),
    data = data,
    random = ~ (1 | individual) + (1 | year), # Both independent
    n.chains = 2,
    n.iter = 2000
)
```

### Nested Random Effects

```{r, eval=FALSE}
# Plots nested within sites
fit <- because(
    equations = list(
        biomass ~ rainfall
    ),
    data = data,
    random = ~ (1 | site / plot), # Expands to (1|site) + (1|site:plot)
    n.chains = 2,
    n.iter = 2000
)
```

### Equation-Specific Random Effects

```{r, eval=FALSE}
# Different random structures for different equations
equations <- list(
    weight ~ age + (1 | individual), # Weight varies by individual
    age ~ cohort # Age is fixed
)

fit <- because(
    equations = equations,
    data = data,
    n.chains = 2,
    n.iter = 2000
)
```

**Note**: Random slopes (e.g., `(age|individual)`) are not yet supported. Use random intercepts only.

---

## Polynomial Transformations

Model non-linear relationships using polynomial terms with the `I()` wrapper.

### Quadratic Relationships

```{r, eval=FALSE}
# Age has a quadratic effect on weight
fit <- because(
    equations = list(
        weight ~ age + I(age^2)
    ),
    data = data,
    n.chains = 2,
    n.iter = 2000
)
```

**What happens**:
- because detects `I(age^2)` 
- Creates internal variable `age_pow2`
- Generates deterministic JAGS node: `age_pow2[i] <- age[i]^2`
- No residual error (perfectly deterministic!)
- Parameters: `beta_age` and `beta_age_pow2`

### Multiple Polynomial Terms

```{r, eval=FALSE}
# Cubic polynomial
fit <- because(
    equations = list(
        y ~ x + I(x^2) + I(x^3)
    ),
    data = data,
    n.chains = 2,
    n.iter = 2000
)
```

### Polynomials for Multiple Variables

```{r, eval=FALSE}
fit <- because(
    equations = list(
        response ~ x + I(x^2) + z + I(z^2)
    ),
    data = data,
    n.chains = 2,
    n.iter = 2000
)
```

**Benefits**:
- No pre-computation needed
- Deterministic (not stochastic)
- Excluded from d-separation basis sets
- Clean, standard R syntax

**Limitations**:
- Only polynomials supported (not `log()`, `sqrt()`, etc.)
- For other transformations, pre-compute in your data

---

## Interaction Terms

Test whether effects depend on other variables.

### Categorical × Continuous

```{r, eval=FALSE}
# Effect of age depends on sex
fit <- because(
    equations = list(
        weight ~ age * sex # Expands to: age + sex + age:sex
    ),
    data = data,
    n.chains = 2,
    n.iter = 2000
)
```

### Continuous × Continuous

```{r, eval=FALSE}
# Interactive effects
fit <- because(
    equations = list(
        growth ~ temperature * rainfall
    ),
    data = data,
    n.chains = 2,
    n.iter = 2000
)
```

**Interpretation**:
- `beta_age`: Effect when sex = 0 (reference level)
- `beta_sex`: Difference between sexes when age = 0
- `beta_age_sex`: How sex modifies the age effect

---

## Categorical Predictors

because automatically handles factor variables.

### Basic Usage

```{r, eval=FALSE}
# Sex as a predictor (automatically dummy-coded)
fit <- because(
    equations = list(
        weight ~ age + sex
    ),
    data = data, # sex should be a factor
    n.chains = 2,
    n.iter = 2000
)
```

### Multiple Levels

```{r, eval=FALSE}
# Habitat type with 3 levels: forest, grassland, wetland
fit <- because(
    equations = list(
        abundance ~ temperature + habitat
    ),
    data = data, # habitat is a factor with 3 levels
    n.chains = 2,
    n.iter = 2000
)
```

**Behind the scenes**:
- R's `model.matrix()` creates dummy variables
- Reference level (first factor level) is baseline
- Parameters estimated for other levels relative to reference

**Recommendations**:
- ✅ Use as **fixed** effects
- ❌ Avoid as random effects (too few levels for variance estimation)

---

## Combining Advanced Features

You can mix multiple advanced features:

```{r, eval=FALSE}
fit <- because(
    equations = list(
        # Polynomial + interaction + random effects
        weight ~ age + I(age^2) + age * sex + (1 | site),

        # Multiple predictors with random effects
        survival ~ weight + temperature + (1 | year)
    ),
    data = data,
    random = ~ (1 | individual), # Global random effect
    n.chains = 3,
    n.iter = 5000
)
```

---

## Best Practices

### Random Effects

1. **Use when**: Observations are grouped/nested
2. **Don't use**: For categorical fixed effects (use regular predictors)
3. **Check convergence**: Random effects can be slow to converge  
4. **Sample size**: Need sufficient groups (>5-10) for variance estimation

### Polynomials

1. **Start simple**: Try linear before adding polynomials
2. **Center predictors**: Can improve interpretation and convergence
3. **Don't overfit**: Higher than cubic (x^3) rarely justified
4. **Check d-separation**: Polynomial relationships are deterministic

### Interactions

1. **Theory-driven**: Only include biologically meaningful interactions
2. **Interpret carefully**: Main effects change meaning with interactions
3. **Center predictors**: Makes main effects more interpretable

---

## See Also

- **[Hierarchical Data](07_hierarchical_data.html)** - Multi-level variables
- **[Model Diagnostics](09_model_diagnostics.html)** - Convergence and interpretation  
- **[Getting Started](01_getting_started.html)** - Basic usage
