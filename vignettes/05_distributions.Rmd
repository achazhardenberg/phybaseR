---
title: "Non-Gaussian Distributions"
author: "Achaz von Hardenberg"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Non-Gaussian Distributions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>", eval = FALSE
)
```

# Non-Gaussian Response Distributions

because supports multiple response distributions to match different data types. Choose the distribution that matches your response variable's characteristics.

## Quick Reference

| Data Type | Distribution | Example |
|-----------|--------------|---------|
| Continuous, normal | `gaussian` | Body mass, temperature |
| Binary (0/1) | `binomial` | Survival, presence/absence |
| Proportions | `binomial` | Hatching success, germination rate |
| Counts | `poisson` | Offspring number, species count |
| Overdispersed counts | `negbinomial` | Parasite load, disease cases |
| Zero-inflated counts | `zip` / `zinb` | Counts with excess zeros |
| Positive continuous | `gamma` | Lifespan, time to event |
| Unordered categories (3+) | `multinomial` | Habitat type, color morph |
| Ordered categories (3+) | `ordinal` | Condition score, severity level |

---

## Binary and Proportion Data

### Binomial Distribution

**For**: Binary outcomes (0/1) or proportions (successes out of trials)

#### Binary Outcomes

```{r, eval=FALSE}
# Survival: 0 = died, 1 = survived
data <- data.frame(
    individual_id = 1:100,
    survival = rbinom(100, 1, 0.7), # Binary: 0 or 1
    age = rnorm(100, 5, 2),
    body_mass = rnorm(100, 50, 10)
)

fit <- because(
    equations = list(
        survival ~ age + body_mass
    ),
    data = data,
    distribution = list(survival = "binomial"),
    n.chains = 3,
    n.iter = 5000
)
```

#### Proportion Data

```{r, eval=FALSE}
# Hatching success: eggs hatched / eggs laid
data <- data.frame(
    nest_id = 1:50,
    eggs_laid = round(runif(50, 5, 12)),
    temperature = rnorm(50, 25, 3)
)
data$eggs_hatched <- rbinom(50, data$eggs_laid, plogis(-2 + 0.3 * data$temperature))
data$prop_hatched <- data$eggs_hatched / data$eggs_laid

# because needs: N (trials) and k (successes)
data$N_trials <- data$eggs_laid
data$N_success <- data$eggs_hatched

fit <- because(
    equations = list(
        prop_hatched ~ temperature
    ),
    data = data,
    distribution = list(prop_hatched = "binomial"),
    n.chains = 3,
    n.iter = 5000
)
```

**Model**: Logit link
```
logit(p) = log(p/(1-p)) = α + β₁x₁ + β₂x₂ + ...
p = probability of success
```

**Interpretation**:
- Positive β: Increases probability
- Negative β: Decreases probability
- Effect on logit scale (not linear!)

---

## Count Data

### Poisson Distribution

**For**: Count data with variance ≈ mean

```{r, eval=FALSE}
# Number of offspring
data <- data.frame(
    female_id = 1:80,
    offspring_count = rpois(80, 3),
    age = rnorm(80, 4, 1.5),
    territory_quality = rnorm(80, 0, 1)
)

fit <- because(
    equations = list(
        offspring_count ~ age + territory_quality
    ),
    data = data,
    distribution = list(offspring_count = "poisson"),
    n.chains = 3,
    n.iter = 5000
)
```

**Model**: Log link
```
log(λ) = α + β₁x₁ + β₂x₂ + ...
λ = expected count (rate)
```

**When to use**:
- Non-negative integers (0, 1, 2, 3, ...)
- No theoretical maximum
- Variance approximately equals mean
- Examples: offspring number, prey captures, seeds produced

**Interpretation**:
- exp(β) = multiplicative effect on count
- β = 0.1 → ~10% increase per unit predictor
- β = -0.2 → ~18% decrease per unit predictor

### Negative Binomial Distribution

**For**: Overdispersed count data (variance > mean)

```{r, eval=FALSE}
# Parasite load (often overdispersed)
data <- data.frame(
    host_id = 1:100,
    parasite_count = rnbinom(100, mu = 10, size = 2), # Overdispersed!
    host_size = rnorm(100, 100, 20),
    immune_function = rnorm(100, 0, 1)
)

fit <- because(
    equations = list(
        parasite_count ~ host_size + immune_function
    ),
    data = data,
    distribution = list(parasite_count = "negbinomial"),
    n.chains = 3,
    n.iter = 5000
)
```

**When to use**:
- Count data with high variance
- Many zeros or extreme values
- Poisson shows poor fit (underdispersion)
- Examples: parasite loads, disease counts, litter sizes

**Advantages over Poisson**:
- Allows variance > mean (more realistic)
- Better fit for biological count data
- Extra dispersion parameter

### Zero-Inflated Distributions (ZIP and ZINB)

**For**: Count data with excess zeros (more than expected by Poisson/NegBin)

#### Zero-Inflated Poisson (ZIP)

```{r, eval=FALSE}
# Abundance data (many sites have 0 species)
data <- data.frame(
    site_id = 1:100,
    abundance = rpois(100, 2),
    habitat_suitability = rnorm(100, 0, 1)
)
# Add excess zeros (structural zeros)
data$abundance[sample(1:100, 30)] <- 0

fit <- because(
    equations = list(
        abundance ~ habitat_suitability
    ),
    data = data,
    distribution = list(abundance = "zip"),
    n.chains = 3,
    n.iter = 5000
)
```

**Model**: Mixture of structural zeros and Poisson counts
```
P(Y=0) = ψ + (1-ψ) * exp(-λ)
P(Y=y) = (1-ψ) * Poisson(y|λ)  (for y > 0)
```
- **ψ (psi)**: Probability of structural zero (Zero-Inflation)
- **λ (lambda)**: Mean of count process

#### Zero-Inflated Negative Binomial (ZINB)

Use when data has both excess zeros AND overdispersion in the non-zero counts.

```{r, eval=FALSE}
fit <- because(
    equations = list(
        abundance ~ habitat_suitability
    ),
    data = data,
    distribution = list(abundance = "zinb"),
    # ...
)
```

**Model**: Mixture of structural zeros and Negative Binomial counts
```
P(Y=0) = ψ + (1-ψ) * (r/(r+μ))^r
P(Y=y) = (1-ψ) * NegBin(y|μ, r) (for y > 0)
```

**Interpretation**:
- **ψ (psi)**: Proportion of "extra" zeros.
- **Count part (μ)**: Interpreted as in standard Poisson/NegBin.


---

## Positive Continuous Data

### Gamma Distribution

**For**: Positive, continuous, right-skewed data

```{r, eval=FALSE}
# Lifespan (always positive, often right-skewed)
data <- data.frame(
    individual_id = 1:120,
    lifespan = rgamma(120, shape = 2, rate = 0.5),
    body_mass = rnorm(120, 50, 10),
    environmental_stress = rnorm(120, 0, 1)
)

fit <- because(
    equations = list(
        lifespan ~ body_mass + environmental_stress
    ),
    data = data,
    distribution = list(lifespan = "gamma"),
    n.chains = 3,
    n.iter = 5000
)
```

**When to use**:
- Strictly positive values (> 0)
- Right-skewed distributions
- Continuous measurements
- Examples: lifespans, time to events, amounts, distances

**Model**: Log link (typically)
```
log(μ) = α + β₁x₁ + β₂x₂ + ...
μ = mean of gamma distribution
```

---

## Categorical Data

### Multinomial Distribution (Unordered)

**For**: Categorical outcomes with 3+ levels,no natural ordering

```{r, eval=FALSE}
# Habitat selection: Forest, Grassland, Wetland
data <- data.frame(
    territory_id = 1:100,
    habitat = sample(c("Forest", "Grassland", "Wetland"), 100, replace = TRUE),
    temperature = rnorm(100, 20, 5),
    precipitation = rnorm(100, 800, 200),
    elevation = rnorm(100, 500, 100)
)

# IMPORTANT: Must be a factor!
data$habitat <- factor(data$habitat,
    levels = c("Forest", "Grassland", "Wetland")
)

fit <- because(
    equations = list(
        habitat ~ temperature + precipitation + elevation
    ),
    data = data,
    distribution = list(habitat = "multinomial"),
    n.chains = 3,
    n.iter = 5000
)
```

**Model**: Multinomial logit (K-1 equations)
```
log(P(category k) / P(reference)) = α_k + β_k1×x1 + β_k2×x2 + ...
```

**Key points**:
- **Reference category**: First factor level (Forest in example)
- **K-1 sets of parameters**: One for each non-reference category
- **No ordering** assumed between categories

**Examples**:
- Habitat types
- Color morphs
- Behavioral states
- Species identity

**Interpretation**:
- Positive β for category k: Increases odds of k vs reference
- Compare categories by comparing their β values

### Ordinal Distribution (Ordered)

**For**: Categorical outcomes with natural ordering

```{r, eval=FALSE}
# Body condition: Poor < Fair < Good < Excellent
data <- data.frame(
    individual_id = 1:150,
    condition = sample(c("Poor", "Fair", "Good", "Excellent"), 150, replace = TRUE),
    food_availability = rnorm(150, 0, 1),
    age = rnorm(150, 5, 2),
    parasite_load = rpois(150, 3)
)

# IMPORTANT: Must be ordered factor!
data$condition <- factor(data$condition,
    levels = c("Poor", "Fair", "Good", "Excellent"),
    ordered = TRUE
)

fit <- because(
    equations = list(
        condition ~ food_availability + age + parasite_load
    ),
    data = data,
    distribution = list(condition = "ordinal"),
    n.chains = 3,
    n.iter = 5000
)
```

**Model**: Cumulative logit (proportional odds)
```
logit(P(Y ≤ category k)) = θ_k - (β₁x₁ + β₂x₂ + ...)
```

**Key points**:
- **K-1 cutpoints** (θ): Thresholds between categories
- **Single set of β**: Same effect across all cutpoints (proportional odds)
- **Respects ordering**: Poor < Fair < Good < Excellent

**Advantages over multinomial**:
- Fewer parameters (more power)
- Respects natural ordering
- More interpretable

**Examples**:
- Condition scores (poor to excellent)
- Severity levels (mild to severe)
- Likert scales (strongly disagree to strongly agree)
- Developmental stages (if ordered)

**Interpretation**:
- Positive β: Increases probability of higher categories
- Negative β: Increases probability of lower categories
- Effect assumed same across all cutpoints

---

## Multiple Response Distributions

You can mix different distributions in one model:

```{r, eval=FALSE}
fit <- because(
    equations = list(
        survival ~ age, # Binomial
        offspring ~ survival, # Poisson
        body_mass ~ age, # Gaussian
        lifespan ~ body_mass, # Gamma
        habitat ~ temperature # Multinomial
    ),
    data = data,
    distribution = list(
        survival = "binomial",
        offspring = "poisson",
        body_mass = "gaussian", # Default, can omit
        lifespan = "gamma",
        habitat = "multinomial"
    ),
    n.chains = 3,
    n.iter = 5000
)
```

---

## Choosing the Right Distribution

### Decision Tree

1. **What type of data?**
   - Continuous → Go to 2
   - Count → Go to 3
   - Categorical → Go to 4

2. **Continuous data**
   - Normally distributed → `gaussian`
   - Positive only, right-skewed → `gamma`
   - Between 0 and 1 (proportion) → `binomial`

3. **Count data**
   - Variance ≈ mean → `poisson`
   - Variance > mean → `negbinomial`
   - Excess zeros → `zip` (if var ≈ mean) or `zinb` (if var > mean)


4. **Categorical data**
   - 2 categories → `binomial`
   - 3+ categories, no order → `multinomial`
   - 3+ categories, ordered → `ordinal`

### Common Mistakes

❌ **Using Gaussian for binary data**
```r
# Wrong!
survival ~ age  # survival is 0/1
distribution = list(survival = "gaussian")
```

✅ **Use binomial**
```r
# Correct
distribution = list(survival = "binomial")
```

❌ **Using Poisson for overdispersed counts**
```r
# Wrong if variance >> mean
parasite_count ~ host_size
distribution = list(parasite_count = "poisson")
```

✅ **Use negative binomial**
```r
# Better
distribution = list(parasite_count = "negbinomial")
```

❌ **Using multinomial for ordered categories**
```r
# Wrong - ignores ordering!
condition ~ food  # Poor < Fair < Good < Excellent
distribution = list(condition = "multinomial")
```

✅ **Use ordinal**
```r
# Correct - respects order
distribution = list(condition = "ordinal")
```

---

## Model Checking

### Residual Diagnostics

For non-Gaussian models, standard residual plots don't work well. Instead:

```{r, eval=FALSE}
# Poisson/negative binomial: Check overdispersion
# Compare variance to mean in residuals

# Binomial: Plot observed vs predicted probabilities

# Ordinal: Check proportional odds assumption
# (effects should be similar across cutpoints)
```

### Model Comparison

Use DIC or WAIC to compare distributions:

```{r, eval=FALSE}
# Try both Poisson and negative binomial
fit_pois <- because(..., distribution = list(count = "poisson"), DIC = TRUE)
fit_nb <- because(..., distribution = list(count = "negbinomial"), DIC = TRUE)

fit_pois$DIC # 543.2
fit_nb$DIC # 512.8  ← Better (lower)

# Negative binomial fits better (ΔIC > 10)
```

---

## Advanced: Link Functions

Each distribution uses a specific link function:

| Distribution | Default Link | Maps |
|--------------|--------------|------|
| Gaussian | Identity | μ ∈ (-∞, ∞) |
| Binomial | Logit | p ∈ (0, 1) |
| Poisson | Log | λ ∈ (0, ∞) |
| Negative binomial | Log | λ ∈ (0, ∞) |
| ZIP / ZINB | Log (count) / Identity* (zero) | λ ∈ (0, ∞), ψ ∈ (0, 1) |
| Gamma | Log | μ ∈ (0, ∞) |

| Multinomial | Logit | probabilities |
|  | Cumulative logit | cumulative probs |

because uses standard links automatically. Custom links are not currently supported.

---

## See Also

- **[Getting Started](01_getting_started.html)** - Basic usage
- **[Advanced Models](06_advanced_models.html)** - Random effects, polynomials
- **[Model Diagnostics](09_model_diagnostics.html)** - Convergence and model comparison
- **[Phylogenetic Models](03_phylogenetic_models.html)** - Works with all distributions!
