---
title: "Phylogenetic Bayesian Structural Equation Models (PhyBaSE)"
author: "Achaz von Hardenberg"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{03. Phylogenetic Models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>",
    eval = FALSE
)
```

The core strength of `because` is combining structural equation modeling with phylogenetic comparative methods implementing in R the PhyBaSE models developed by von Hardenberg and Gonzalez-Voyer (2025). 

In this tutorial we will demonstrate how to fit the models presented in von Hardenberg and Gonzalez-Voyer (2025) with the convenience of the `because` package.

Once again we will use the Rhinogradentia dataset and tree previously analysed in Gonzalez-Voyer and von Hardenberg, (2014) and in von Hardenberg and Gonzalez-Voyer (2025). Let's start by loading the necessary packages and data:
```{r}
library(because)
library(ape)

data(rhino.dat)
data(rhino.tree)
```

While in previus implementations it was necessary to compute the variance-covariance matrix from the tree and pass it to JAGS, `because` handles this internally. You only need to provide the phylogenetic tree (class `phylo`) via the `structure` argument. Also, `because` automatically matches the species names in the data and tree: you only need to ensure that the species names in the data frame column specified by `species` match the tip labels in the tree and provide the name of the species column to the `because()` function through the `id_col` argument. Also, you do not need to rescale the total tree length to 1 (needed for a correct estimation of Pagel's lambda parameter), as `because` will handle this internally.

So, let's specify the structural equations of the best model (sem8) as fitted by von Hardenberg and Gonzalez-Voyer (2025):
```{r}
sem8_eq <- list(
    LS ~ BM,
    NL ~ BM + RS,
    DD ~ NL
)
```

Now we can fit the model with `because()` including the phylogenetic tree with the `structure` argument:
```{r}
fit_sem8 <- because(
    equations = sem8_eq,
    data = rhino.dat,
    structure = rhino.tree,
    id_col = "SP")

summary(fit_sem8)
```

```
                 Mean    SD Naive SE Time-series SE   2.5%    50% 97.5%  Rhat n.eff
alphaDD         0.582 0.276    0.005          0.007  0.049  0.573 1.150 1.001  1682
alphaLS         0.345 0.412    0.008          0.018 -0.493  0.350 1.140 1.001   529
alphaNL        -0.046 0.328    0.006          0.013 -0.679 -0.047 0.618 1.002   622
beta_DD_NL      0.538 0.076    0.001          0.001  0.387  0.537 0.687 1.000  2676
beta_LS_BM      0.475 0.087    0.002          0.002  0.307  0.474 0.647 1.000  2166
beta_NL_BM      0.470 0.068    0.001          0.001  0.337  0.470 0.603 1.000  2221
beta_NL_RS      0.595 0.066    0.001          0.001  0.464  0.594 0.728 1.000  2366
sigma_DD_phylo  0.791 0.173    0.003          0.004  0.490  0.779 1.174 1.000  1969
sigma_DD_res    0.857 0.091    0.002          0.002  0.688  0.854 1.044 1.000  2429
sigma_LS_phylo  1.251 0.210    0.004          0.006  0.856  1.244 1.689 1.000  1487
sigma_LS_res    0.804 0.106    0.002          0.002  0.617  0.798 1.035 1.000  1962
sigma_NL_phylo  1.029 0.148    0.003          0.004  0.765  1.019 1.348 1.000  1478
sigma_NL_res    0.623 0.076    0.001          0.002  0.484  0.619 0.784 1.000  2125

DIC:
Mean deviance:  671.5 
penalty 133 
Penalized deviance: 804.5 
```
The output shows that the posterior parameters are similar 
