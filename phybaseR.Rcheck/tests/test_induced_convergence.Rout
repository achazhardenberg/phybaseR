
R version 4.5.2 (2025-10-31) -- "[Not] Part in a Rumble"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> library(phybaseR)
> library(coda)
> 
> # Simulate data similar to rhino structure
> set.seed(42)
> N <- 50
> 
> # Create correlated structure from latent variable
> L1 <- rnorm(N)
> LS <- 0.6 * L1 + rnorm(N, 0, 0.3)
> NL <- 0.5 * L1 + 0.4 * rnorm(N) + rnorm(N, 0, 0.3) # RS effect + L1 effect
> RS <- rnorm(N)
> NL <- NL + 0.4 * RS # Add RS effect
> DD <- 0.7 * NL + rnorm(N, 0, 0.3)
> 
> # Standardize for better convergence
> df <- data.frame(
+     SP = paste0("sp", 1:N),
+     LS = scale(LS)[, 1],
+     NL = scale(NL)[, 1],
+     RS = scale(RS)[, 1],
+     DD = scale(DD)[, 1]
+ )
> 
> equations <- list(
+     LS ~ L1,
+     NL ~ L1 + RS,
+     DD ~ NL
+ )
> 
> cat("Running MAG model with induced correlations...\n")
Running MAG model with induced correlations...
> 
> fit <- phybase_run(
+     data = df,
+     id_col = "SP",
+     latent = "L1",
+     equations = equations,
+     latent_method = "correlations",
+     n.chains = 3,
+     n.iter = 3000,
+     n.burnin = 1000,
+     quiet = TRUE
+ )
> 
> cat("\n=== JAGS Model Check ===\n")

=== JAGS Model Check ===
> model_str <- fit$model_code
> cat("Looking for 'tau_obs_NL ~ dgamma' (should be estimated):\n")
Looking for 'tau_obs_NL ~ dgamma' (should be estimated):
> if (grepl("tau_obs_NL ~ dgamma", model_str)) {
+     cat("✓ PASS: tau_obs is estimated (not fixed)\n")
+ } else if (grepl("tau_obs_NL <- 10000", model_str)) {
+     cat("✗ FAIL: tau_obs is still fixed at 10000\n")
+ }
✓ PASS: tau_obs is estimated (not fixed)
> 
> cat("\nLooking for 'RS[i] ~ dnorm' (should NOT be present):\n")

Looking for 'RS[i] ~ dnorm' (should NOT be present):
> if (grepl("RS\\[i\\] ~ dnorm", model_str)) {
+     cat("✗ FAIL: RS is being estimated as stochastic\n")
+ } else {
+     cat("✓ PASS: RS is treated as observed data\n")
+ }
✓ PASS: RS is treated as observed data
> 
> cat("\n=== Convergence Diagnostics ===\n")

=== Convergence Diagnostics ===
> mcmc_samples <- fit$samples
> rhats <- gelman.diag(mcmc_samples)$psrf[, 1]
> beta_rhat <- rhats["beta_NL_RS"]
> cat(sprintf(
+     "beta_NL_RS Rhat: %.3f %s\n",
+     beta_rhat,
+     ifelse(beta_rhat < 1.1, "✓ GOOD", "✗ POOR")
+ ))
beta_NL_RS Rhat: 1.007 ✓ GOOD
> 
> neff <- effectiveSize(mcmc_samples)["beta_NL_RS"]
> cat(sprintf(
+     "beta_NL_RS n.eff: %.1f %s\n",
+     neff,
+     ifelse(neff > 100, "✓ GOOD", ifelse(neff > 20, "~ OK", "✗ POOR"))
+ ))
beta_NL_RS n.eff: 510.8 ✓ GOOD
> 
> cat("\n=== Summary ===\n")

=== Summary ===
> print(summary(mcmc_samples[, "beta_NL_RS"]))

Iterations = 1010:3000
Thinning interval = 10 
Number of chains = 3 
Sample size per chain = 200 

1. Empirical mean and standard deviation for each variable,
   plus standard error of the mean:

          Mean             SD       Naive SE Time-series SE 
      0.543296       0.100940       0.004121       0.004571 

2. Quantiles for each variable:

  2.5%    25%    50%    75%  97.5% 
0.3252 0.4803 0.5446 0.6159 0.7270 

> 
> proc.time()
   user  system elapsed 
  2.548   0.136   3.077 
