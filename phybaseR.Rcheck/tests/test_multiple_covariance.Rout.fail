
R version 4.5.2 (2025-10-31) -- "[Not] Part in a Rumble"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # Test for Multiple Covariance Support (Phylo + Spatial)
> # Checks if parameters are recovered correctly from a model with two additive random effects.
> 
> library(phybaseR)
> library(ape)
> library(MASS) # For mvrnorm
> library(coda) # For summary.mcmc.list
> devtools::load_all(".")
â„¹ Loading phybaseR
> 
> set.seed(42)
> 
> # 1. Simulation Setup
> N <- 50
> tree <- ape::rcoal(N)
> dist_mat <- as.matrix(dist(1:N)) # Simple 1D distance for spatial
> # Or strictly, make 2D spatial
> coords <- matrix(runif(N * 2), N, 2)
> dist_mat <- as.matrix(dist(coords))
> 
> # True Parameters
> sigma_phylo <- 1.5 # tau_phylo = 1/(1.5^2) = 0.44
> sigma_spatial <- 1.0 # tau_spatial = 1/(1^2) = 1.0
> sigma_resid <- 0.5 # tau_resid = 1/(0.5^2) = 4.0
> beta_x <- 0.8
> 
> # Covariance Matrices
> V_phylo <- ape::vcv.phylo(tree)
> V_spatial <- exp(-dist_mat / 0.5) # Range 0.5
> 
> # Simulate Random Effects
> u_phylo <- mvrnorm(1, mu = rep(0, N), Sigma = sigma_phylo^2 * V_phylo)
> u_spatial <- mvrnorm(1, mu = rep(0, N), Sigma = sigma_spatial^2 * V_spatial)
> epsilon <- rnorm(N, 0, sigma_resid)
> 
> # Predictor
> X <- rnorm(N)
> # Response
> # Y = beta*X + u_phylo + u_spatial + epsilon
> Y <- beta_x * X + u_phylo + u_spatial + epsilon
> 
> data <- list(Y = Y, X = X)
> equations <- list(Y ~ X)
> 
> # 2. Fit Model
> # Pass list of structures
> # Note: phybaseR expects Covariance-like objects (Tree or Matrix) and inverts them.
> structure_list <- list(
+     phylo = tree,
+     spatial = V_spatial
+ )
> 
> message("Fitting Multi-Structure Model...")
Fitting Multi-Structure Model...
> fit <- phybase_run(
+     data = data,
+     equations = equations,
+     structure = structure_list,
+     n.iter = 5000,
+     n.burnin = 1000,
+     n.thin = 5,
+     quiet = FALSE
+ )
Standardizing tree (max_bt: 1.54 -> 1.0)
Compiling model graph
   Resolving undeclared variables
   Allocating nodes
Graph information:
   Observed stochastic nodes: 50
   Unobserved stochastic nodes: 7
   Total graph size: 8070

Initializing model

Warning message:
In rjags::jags.model(model_file, data = data, n.chains = n.chains,  :
  Unused variable "ID2" in data
> 
> # 3. Validation
> message("\n--- Summary ---")

--- Summary ---
> print(summary(fit))
                 Mean    SD Naive SE Time-series SE   2.5%   50% 97.5%  Rhat
alphaY          0.606 1.118    0.023          0.126 -1.551 0.585 2.814 1.160
beta_Y_X        0.739 0.166    0.003          0.004  0.420 0.741 1.072 1.000
sigma_Y_phylo   1.674 0.446    0.009          0.029  1.001 1.612 2.815 1.001
sigma_Y_res     0.682 0.140    0.003          0.004  0.444 0.666 0.992 0.999
sigma_Y_spatial 1.024 0.254    0.005          0.010  0.573 1.004 1.542 1.001
                n.eff
alphaY             74
beta_Y_X         1783
sigma_Y_phylo     237
sigma_Y_res      1139
sigma_Y_spatial   729

DIC:
Mean deviance:  98.97 
penalty 36.11 
Penalized deviance: 135.1 
                 Mean    SD Naive SE Time-series SE   2.5%   50% 97.5%  Rhat
alphaY          0.606 1.118    0.023          0.126 -1.551 0.585 2.814 1.160
beta_Y_X        0.739 0.166    0.003          0.004  0.420 0.741 1.072 1.000
sigma_Y_phylo   1.674 0.446    0.009          0.029  1.001 1.612 2.815 1.001
sigma_Y_res     0.682 0.140    0.003          0.004  0.444 0.666 0.992 0.999
sigma_Y_spatial 1.024 0.254    0.005          0.010  0.573 1.004 1.542 1.001
                n.eff
alphaY             74
beta_Y_X         1783
sigma_Y_phylo     237
sigma_Y_res      1139
sigma_Y_spatial   729
> 
> # Extract posteriors from JAGS object (fit$model)
> # Note: phybase_run returns 'fit' which has 'model' (rjags object) or samples?
> # phybase_run returns 'mcmc.list' usually?
> # Let's check phybase_run return. It returns 'result' which is mcmc.list (if parallel) or jags object?
> # It returns a list with 'posteriors' (mcmc.list).
> 
> # Check variable names
> params <- colnames(fit$posteriors[[1]])
> message("Parameters: ", paste(params, collapse = ", "))
Parameters: 
> 
> # Expect: tau_u_Y_phylo, tau_u_Y_spatial, tau_e_Y
> # And beta_Y_X, alpha_Y
> 
> # Use summary of posteriors (mcmc.list)
> summ <- summary(fit$posteriors)
> get_mean <- function(param) {
+     if (param %in% rownames(summ$statistics)) {
+         return(summ$statistics[param, "Mean"])
+     } else {
+         warning(paste("Param not found:", param))
+         return(NA)
+     }
+ }
> 
> est_sigma_phylo <- get_mean("sigma_Y_phylo")
Error in summ$statistics : $ operator is invalid for atomic vectors
Calls: get_mean -> %in% -> rownames -> %||%
Execution halted
