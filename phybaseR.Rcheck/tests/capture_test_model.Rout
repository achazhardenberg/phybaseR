
R version 4.5.2 (2025-10-31) -- "[Not] Part in a Rumble"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # Script to run test and capture JAGS model
> Sys.setenv(NOT_CRAN = 'true')
> devtools::load_all()
â„¹ Loading phybaseR
> library(testthat)
> 
> # Run the test but catch errors and save model files
> set.seed(123)
> N <- 100
> K <- 3
> tree <- ape::rtree(N)
> C <- ape::vcv(tree)
> 
> X <- rnorm(N)
> 
> # Simulate data (same as test)
> phy1 <- MASS::mvrnorm(1, mu = rep(0, N), Sigma = 0.8 * C + diag(0.1, N))
> L1 <- 0.5 + 1.2 * X + phy1
> 
> phy2 <- MASS::mvrnorm(1, mu = rep(0, N), Sigma = 0.5 * C + diag(0.1, N))
> L2 <- -0.5 - 0.8 * X + phy2
> 
> P <- matrix(0, N, K)
> denom <- 1 + exp(L1) + exp(L2)
> P[, 1] <- 1 / denom
> P[, 2] <- exp(L1) / denom
> P[, 3] <- exp(L2) / denom
> 
> Y <- numeric(N)
> for (i in 1:N) {
+     Y[i] <- sample(1:K, 1, prob = P[i, ])
+ }
> Y <- factor(Y)
> 
> data_list <- list(Y = Y, X = X)
> 
> tryCatch(
+     {
+         res <- phybase_run(
+             equations = list(Y ~ X),
+             data = data_list,
+             tree = tree,
+             distribution = c(Y = "multinomial"),
+             n.iter = 1000,
+             n.burnin = 500,
+             n.chains = 2,
+             quiet = TRUE
+         )
+     },
+     error = function(e) {
+         cat("\n=== TEST ERROR ===\n")
+         cat(e$message, "\n")
+ 
+         # Find latest model file
+         model_files <- list.files(
+             tempdir(),
+             pattern = "\\.jg$",
+             full.names = TRUE
+         )
+         if (length(model_files) > 0) {
+             latest <- model_files[which.max(file.mtime(model_files))]
+             cat("\n=== JAGS MODEL FROM TEST ===\n")
+             cat(readLines(latest), sep = "\n")
+             cat("\n=== END MODEL ===\n")
+         }
+     }
+ )

=== TEST ERROR ===
RUNTIME ERROR:
Compilation error on line 25.
Unknown variable Prec_phylo_fixed
Either supply values for this variable with the data
or define it  on the left hand side of a relation.

 

=== JAGS MODEL FROM TEST ===
model {
  # Dummy usage of ID to prevent warnings in GLMM-only models
  dummy_ID <- ID[1,1]
  # Structural equations
  for (i in 1:N) {
    # Multinomial linear predictor for Y
    L_Y[i, 1] <- 0
    for (k in 2:K_Y) {
      L_Y[i, k] <- alpha_Y[k] + beta_Y_X[k] * X[i] + err_Y[i, k]
    }
    # Softmax for Y
    for (k in 1:K_Y) {
      exp_L_Y[i, k] <- exp(L_Y[i, k])
    }
    sum_exp_L_Y[i] <- sum(exp_L_Y[i, 1:K_Y])
    for (k in 1:K_Y) {
      p_Y[i, k] <- exp_L_Y[i, k] / sum_exp_L_Y[i]
    }
    Y[i] ~ dcat(p_Y[i, 1:K_Y])
    log_lik_Y[i] <- logdensity.cat(Y[i], p_Y[i, 1:K_Y])
  }
  # Multivariate normal likelihoods
  # Random effects for multinomial: Y
  for (k in 2:K_Y) {
    u_std_Y[1:N, k] ~ dmnorm(zeros[1:N], Prec_phylo_fixed[1:N, 1:N])
    for (i in 1:N) {
      u_Y[i, k] <- u_std_Y[i, k] / sqrt(tau_u_Y[k])
      epsilon_Y[i, k] ~ dnorm(0, tau_e_Y[k])
      err_Y[i, k] <- u_Y[i, k] + epsilon_Y[i, k]
    }
  }
  # Priors for structural parameters
  # Priors for Y (Multinomial)
  for (k in 2:K_Y) {
    alpha_Y[k] ~ dnorm(0, 1.0E-6)
    tau_u_Y[k] ~ dgamma(1, 1)
    tau_e_Y[k] ~ dgamma(1, 1)
    lambda_Y[k] <- (1/tau_u_Y[k]) / ((1/tau_u_Y[k]) + (1/tau_e_Y[k]))
  }
  for (k in 2:K_Y) {
    beta_Y_X[k] ~ dnorm(0, 1.0E-6)
  }
  for(k in 1:N) { zero_vec[k] <- 0 }
  # Covariance structure for responses
  # Predictor priors for imputation
}

=== END MODEL ===
Warning messages:
1: In rjags::jags.model(model_file, data = data, n.chains = n.chains,  :
  Unused variable "Prec_phylo" in data
2: In rjags::jags.model(model_file, data = data, n.chains = n.chains,  :
  Unused variable "ID2" in data
> 
> proc.time()
   user  system elapsed 
  0.885   0.107   1.229 
